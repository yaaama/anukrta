# ==========================================
#   Project Settings
# ==========================================
TARGET_NAME := anukrta
SRC_DIR := src
OBJ_DIR := build/objs
BIN_DIR := build
INC_DIR := include

# Compiler settings
CC := gcc

ASAN := 1
DEV_FLAGS := -ggdb -O0 -g -Wstrict-prototypes -Wold-style-definition -Wshadow	\
-Wvla -pedantic -Wno-unused-parameter -Wno-unused-variable -Wno-unused-function
# Standard warnings + optimizations + debug info

RELEASE_FLAGS := -O2
CFLAGS := -std=c11 -Wall -Wextra

ifeq (${DEBUG}, 1)
	CFLAGS += $(DEV_FLAGS)
endif

# ==========================================
#   FFmpeg Configuration (No pkg-config)
# ==========================================
# Set the root directory where FFmpeg is installed.
# Common paths: /usr, /usr/local, /opt/ffmpeg
FFMPEG_ROOT := /usr

# Include Flags (Headers)
FFMPEG_INC := -I$(FFMPEG_ROOT)/include

# Linker Flags (Library paths)
# -Wl,-rpath sets the runtime library path so you don't need LD_LIBRARY_PATH
FFMPEG_LIBDIR := -L$(FFMPEG_ROOT)/lib
FFMPEG_RPATH := -Wl,-rpath,$(FFMPEG_ROOT)/lib

# Specific FFmpeg Libraries to link (Add/Remove as needed)
FFMPEG_LIBS := -lavformat -lavcodec -lavutil -lswscale -lswresample

# ==========================================
#   Programmatic File Discovery
# ==========================================
# Find all .c files in SRC_DIR
SOURCES := $(wildcard $(SRC_DIR)/*.c)
# Create object file names (e.g., src/main.c -> obj/main.o)
OBJECTS := $(SOURCES:$(SRC_DIR)/%.c=$(OBJ_DIR)/%.o)
# Dependency files (generated by compiler)
DEPS := $(OBJECTS:.o=.d)

# Combine flags
ALL_CFLAGS := $(CFLAGS) -I$(INC_DIR) $(FFMPEG_INC) -MMD -MP
ALL_LDFLAGS := $(FFMPEG_LIBDIR) $(FFMPEG_RPATH)
ALL_LDLIBS := $(FFMPEG_LIBS) -lm -lpthread -lz


ifeq (${ASAN}, 1)
ASAN_FLAGS := -fsanitize=address,undefined
	ALL_CFLAGS += $(ASAN_FLAGS)
	ALL_LDFLAGS += $(ASAN_FLAGS)
	ASAN_LOG_FILE = asan.log
	ASAN_OPTIONS="log_path=$(ASAN_LOG_FILE)"
endif


# ==========================================
#   Build Rules
# ==========================================

# 1. Main Target
.PHONY: all test bear clean
all: $(BIN_DIR)/$(TARGET_NAME)

# 2. Linking
$(BIN_DIR)/$(TARGET_NAME): $(OBJECTS) | $(BIN_DIR)
	@echo "Linking $(TARGET_NAME)..."
	$(CC) $(ALL_LDFLAGS) $^ $(ALL_LDLIBS) -o $@

# 3. Compiling
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c | $(OBJ_DIR)
	@echo "Compiling $<..."
	$(CC) $(ALL_CFLAGS) -c $< -o $@

# 4. Directory Creation
$(BIN_DIR) $(OBJ_DIR):
	@mkdir -p $@

# 5. Clean
clean:
	@echo "Cleaning up..."
	@rm -rf $(OBJ_DIR) $(BIN_DIR)

# 6. Include Dependencies
# -include $(DEPS)

compile_commands.json: clean
	@echo "Generating compile_commands.json..."
	bear -- $(MAKE) all

# Alias for convenience
bear: compile_commands.json

test:
	@echo "NOT IMPLEMENTED."
